<!DOCTYPE html>
<html lang="es-CO">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Productos - MV Inventario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/unified-theme.css">
  <link rel="stylesheet" href="../styles/theme-variables.css">
  <link rel="stylesheet" href="../styles/header-professional.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/overrides.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Drawer styling to match Movements */
    .drawer { max-height:0; overflow:hidden; transition: max-height .4s ease; background:#fff; border-radius:12px; padding:0 1rem; margin:8px 0 16px; border:1px solid var(--border-color); }
    .drawer.open { max-height:900px; padding:1rem; }
    .drawer-header{ display:flex; justify-content:space-between; align-items:center; padding-bottom:6px; border-bottom:1px solid var(--border-color); margin-bottom:8px; }
    .drawer-body{ display:flex; flex-direction:column; gap:8px; }
    .drawer-footer{ display:flex; justify-content:flex-end; padding-top:8px; border-top:1px solid var(--border-color); }
  </style>
</head>
<body class="bg-gradient-to-r from-violet-900 via-violet-700 to-indigo-900 min-h-screen">
  <!-- Navbar profesional unificado -->
  <nav class="navbar-professional" aria-label="Main Navigation">
    <div style="display:flex; align-items:center; gap:24px;">
      <a href="dashboard.html" class="navbar-brand"><i class="bi bi-boxes"></i> Inventario MV</a>
      <a href="dashboard.html" class="nav-link" style="color:white;">Inventario</a>
      <a href="productos.html" class="nav-link active" style="color:white;">Productos</a>
      <a href="analytics.html" class="nav-link" style="color:white;">Análisis</a>
    </div>
    <div class="navbar-actions">
      <button class="nav-icon-button" id="darkModeBtn" title="Modo Oscuro"><i class="bi bi-moon"></i></button>
      <button class="nav-icon-button" id="logoutBtn" title="Salir"><i class="bi bi-box-arrow-right"></i></button>
    </div>
  </nav>

  <main class="container mx-auto py-6 px-4">
    <div class="flex items-center justify-between mb-4">
      <div class="text-left">
        <h1 class="text-2xl font-bold text-white"><i class="bi bi-box"></i> Gestión de Productos</h1>
        <p class="text-white/70">Administra el catálogo completo de productos, stock y precios</p>
      </div>
      <button class="btn btn-primary" id="btnNuevoProducto">
        <i class="bi bi-plus-lg"></i> Nuevo Producto
      </button>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="estadisticasContainer">
      <div class="card-kpi"><i class="bi bi-box"></i><h5>Total Productos</h5><p class="number" id="totalProductos">0</p></div>
      <div class="card-kpi"><i class="bi bi-exclamation-triangle"></i><h5>Stock Bajo</h5><p class="number" id="stockBajo">0</p></div>
      <div class="card-kpi"><i class="bi bi-cash-coin"></i><h5>Valor Inventario</h5><p class="number" id="valorInventario">$0</p></div>
      <div class="card-kpi"><i class="bi bi-percent"></i><h5>Margen Promedio</h5><p class="number" id="margenPromedio">0%</p></div>
    </div>

    <!-- Filters -->
    <div class="card filter-card p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div class="flex items-center">
          <i class="bi bi-search text-white mr-2"></i>
          <input id="filtroNombre" class="form-control" placeholder="Buscar por nombre o código..." />
        </div>
        <select id="filtroCategoria" class="form-control"><option value="">Todas las categorías</option></select>
        <select id="filtroEstado" class="form-control"><option value="">Todos los estados</option><option value="VIGENTE">Vigente</option><option value="VENCIDO">Vencido</option></select>
      </div>
    </div>

    <!-- Drawer Nuevo Producto (oculto por defecto) -->
    <div id="nuevoProductoDrawer" class="drawer">
      <div class="drawer-header">
        <h3>Nuevo Producto</h3>
        <button id="drawerClose" class="btn-close" aria-label="Cerrar drawer"></button>
      </div>
      <div class="drawer-body">
        <form id="formProducto" autocomplete="off">
          <input type="hidden" id="productoIdDrawer" />
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="form-label">Código <span class="text-danger">*</span></label>
              <input type="text" id="codigo" class="form-control" required />
            </div>
            <div>
              <label class="form-label">Nombre <span class="text-danger">*</span></label>
              <input type="text" id="nombre" class="form-control" required />
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Descripción</label>
            <textarea id="descripcion" class="form-control" rows="2"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-3">
            <div>
              <label class="form-label">Categoría <span class="text-danger">*</span></label>
              <select id="categoria" class="form-control" required>
                <option value="">Seleccione categoría</option>
              </select>
            </div>
            <div>
              <label class="form-label">Ubicación</label>
              <input id="ubicacion" class="form-control" />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-3">
            <div>
              <label class="form-label">Precio Compra <span class="text-danger">*</span></label>
              <input id="precioCompra" type="number" step="0.01" class="form-control" required />
            </div>
            <div>
              <label class="form-label">Precio Venta <span class="text-danger">*</span></label>
              <input id="precioVenta" type="number" step="0.01" class="form-control" required />
            </div>
          </div>
          <div class="grid grid-cols-3 gap-4 mt-3">
            <div>
              <label class="form-label">Cantidad <span class="text-danger">*</span></label>
              <input id="cantidad" type="number" value="0" class="form-control" required />
            </div>
            <div>
              <label class="form-label">Stock Mínimo</label>
              <input id="stockMinimo" type="number" value="10" class="form-control" />
            </div>
            <div>
              <label class="form-label">Margen (%)</label>
              <input id="margenCalculado" type="text" class="form-control" readonly />
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Fecha de Vencimiento</label>
            <input id="fechaVencimiento" type="date" class="form-control" />
          </div>
        </form>
      </div>
      <div class="drawer-footer">
        <button id="drawerCancelar" class="btn btn-secondary me-2">Cancelar</button>
        <button id="drawerGuardar" class="btn btn-primary"><i class="bi bi-check-lg"></i> Guardar</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script src="../scripts/app.js"></script>
  <script src="../scripts/productos.js"></script>
  <script>
    // Drawer logic for Nuevo Producto
    document.addEventListener('DOMContentLoaded', function() {
      const btnNuevo = document.getElementById('btnNuevoProducto');
      const drawer = document.getElementById('nuevoProductoDrawer');
      const drawerClose = document.getElementById('drawerClose');
      const drawerCancelar = document.getElementById('drawerCancelar');
      const drawerGuardar = document.getElementById('drawerGuardar');
      
      function openDrawer(){ if (drawer) { drawer.classList.add('open'); resetDrawerForm(); } }
      function closeDrawer(){ if (drawer) drawer.classList.remove('open'); }
      function resetDrawerForm(){ const f = document.getElementById('formProducto'); if (f) f.reset(); }
      if (btnNuevo) btnNuevo.addEventListener('click', openDrawer);
      if (drawerClose) drawerClose.addEventListener('click', closeDrawer);
      if (drawerCancelar) drawerCancelar.addEventListener('click', closeDrawer);
      if (drawerGuardar) drawerGuardar.addEventListener('click', guardarProductoDrawer);
    });

    function guardarProductoDrawer() {
      const payload = {
        codigo: document.getElementById('codigo').value,
        nombre: document.getElementById('nombre').value,
        descripcion: document.getElementById('descripcion').value,
        id_categoria: document.getElementById('categoria').value || null,
        ubicacion: document.getElementById('ubicacion').value,
        precio_compra: parseFloat(document.getElementById('precioCompra').value) || 0,
        precio_venta: parseFloat(document.getElementById('precioVenta').value) || 0,
        cantidad: parseInt(document.getElementById('cantidad').value) || 0,
        stock_minimo: parseInt(document.getElementById('stockMinimo').value) || 0,
        fecha_vencimiento: document.getElementById('fechaVencimiento').value || null
      };
      fetch('/api/productos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '') },
        body: JSON.stringify(payload)
      }).then(r => r.json())
        .then(res => {
          if (res.success) {
            document.getElementById('nuevoProductoDrawer').classList.remove('open');
            // recargar tabla
            if (typeof cargarProductos === 'function') cargarProductos();
          } else {
            alert('Error: ' + (res.message || 'Error al guardar'));
          }
        }).catch(err => {
          console.error(err);
          alert('Error al guardar producto');
        });
    }
  </script>
</body>
</html>
