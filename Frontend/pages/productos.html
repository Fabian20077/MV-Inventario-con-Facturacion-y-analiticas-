﻿<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos - Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="../styles/unified-theme.css">
    <link rel="stylesheet" href="../styles/components.css">
    <link rel="stylesheet" href="../styles/overrides.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-light: #ffffff;
            --text-dark: #333333;
            --border-color: #e0e0e0;
        }

        body.dark-mode {
            --bg-light: #1e1e2e;
            --text-dark: #ffffff;
            --border-color: #404050;
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-dark);
        }

        body.dark-mode .text-danger {
            color: #ff6b6b !important;
        }

        body.dark-mode .text-muted {
            color: #adb5bd !important;
        }

        .container-wrapper {
            background: var(--bg-light);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            margin-bottom: 30px;
            padding: 30px;
            color: var(--text-dark);
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-section h1 {
            color: var(--text-dark);
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 2rem;
        }

        .header-section .btn-grupo {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        .table {
            color: #333333;
            background-color: #ffffff;
            margin-bottom: 0;
        }

        .table td,
        .table th {
            color: #333333;
            background-color: #ffffff;
            vertical-align: middle;
            padding: 16px 12px;
        }

        .table thead {
            background: #f5f5f5;
            color: #333333;
        }

        .table thead th {
            color: #555555 !important;
            background: #f5f5f5 !important;
            font-weight: 600;
            padding: 16px 12px;
            border: none;
            border-bottom: 2px solid #e0e0e0;
        }

        .table thead th {
            color: #ffffff !important;
            background: var(--primary-gradient) !important;
        }

        .table tbody tr {
            border-bottom: 3px solid #000000;
            background-color: #ffffff;
        }

        .table tbody td {
            color: #333333;
            background-color: #ffffff;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .badge-estado {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-vigente {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-vencido {
            background-color: #f8d7da;
            color: #721c24;
        }

        .stock-bajo {
            color: #dc3545;
            font-weight: 600;
        }

        .stock-normal {
            color: #28a745;
            font-weight: 600;
        }

        .margin-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .margin-high {
            background-color: #d4edda;
            color: #155724;
        }

        .margin-medium {
            background-color: #fff3cd;
            color: #856404;
        }

        .margin-low {
            background-color: #f8d7da;
            color: #721c24;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .modal-header {
            background: var(--primary-gradient);
            color: white;
        }

        .modal-content {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .form-control,
        .form-select {
            background: #ffffff;
            color: #333333;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.95rem;
        }

        .form-control::placeholder {
            color: #999999;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.1);
            background: #ffffff;
            color: #333333;
        }

        .input-group-text {
            background: transparent !important;
            border: 1.5px solid #e0e0e0;
            color: #999999;
        }

        .back-button {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .back-button:hover {
            background-color: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
            color: #667eea;
            text-decoration: none;
        }

        .btn-new {
            background: var(--primary-gradient);
            color: white !important;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn-new:hover {
            transform: translateY(-2px);
            color: white !important;
            text-decoration: none;
        }

        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .filter-section input,
        .filter-section select {
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #ffffff;
            color: #1e3a8a;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .stat-card h5 {
            margin: 0;
            font-size: 0.85rem;
            color: #666666;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: #1e3a8a;
        }

        .stat-card i {
            font-size: 1.5rem;
            color: #667eea;
            opacity: 0.8;
        }

        .dark-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .dark-mode-toggle:hover {
            opacity: 0.9;
        }

        .btn-edit,
        .btn-delete {
            padding: 5px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit {
            background-color: #0d6efd;
            color: white;
        }

        .btn-edit:hover {
            background-color: #0b5ed7;
            transform: scale(1.05);
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background-color: #bb2d3b;
            transform: scale(1.05);
        }

        /* Dark Mode Enhancements */
        body.dark-mode .table {
            background-color: #1e1e2e;
            color: #ffffff;
        }

        body.dark-mode .table td,
        body.dark-mode .table th {
            color: #ffffff;
            background-color: #1e1e2e;
            border-color: #404050;
        }

        body.dark-mode .table tbody tr {
            background-color: #1e1e2e;
            border-bottom: 1px solid #404050;
        }

        body.dark-mode .table tbody td {
            color: #ffffff;
            background-color: #1e1e2e;
        }

        body.dark-mode .table tbody tr:hover {
            background-color: #2a2a3e !important;
        }

        body.dark-mode .table thead {
            background: #2a2a3e;
        }

        body.dark-mode .table thead th {
            color: #cccccc !important;
            background: #2a2a3e !important;
            border-bottom-color: #404050;
        }

        body.dark-mode .badge-vigente {
            background-color: #1e4d2b;
            color: #90ee90;
        }

        body.dark-mode .badge-vencido {
            background-color: #4d1e1e;
            color: #ff6b6b;
        }

        body.dark-mode .badge-estado {
            color: inherit;
        }

        body.dark-mode .stock-bajo {
            color: #ff6b6b;
        }

        body.dark-mode .stock-normal {
            color: #90ee90;
        }

        body.dark-mode .margin-high {
            background-color: #1e4d2b;
            color: #90ee90;
        }

        body.dark-mode .margin-medium {
            background-color: #4d3d1e;
            color: #ffd700;
        }

        body.dark-mode .margin-low {
            background-color: #4d1e1e;
            color: #ff6b6b;
        }

        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: #2a2a3e;
            border-color: #404050;
            color: #ffffff;
        }

        body.dark-mode .form-control::placeholder {
            color: #888888;
        }

        body.dark-mode .form-control:focus,
        body.dark-mode .form-select:focus {
            background-color: #2a2a3e;
            border-color: #667eea;
            color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        body.dark-mode .filter-section {
            background: rgba(102, 126, 234, 0.1);
            border-color: #404050;
        }

        body.dark-mode .stat-card {
            background: #2a2a3e;
            color: #5a9fd4;
            border-color: #404050;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .stat-card h5 {
            color: #aaaaaa;
        }

        body.dark-mode .stat-card .number {
            color: #5a9fd4;
        }

        body.dark-mode .stat-card i {
            color: #667eea;
        }

        body.dark-mode .back-button {
            background: transparent;
            color: #667eea;
            border-color: #667eea;
        }

        body.dark-mode .back-button:hover {
            background-color: rgba(102, 126, 234, 0.15);
        }

        body.dark-mode .input-group-text {
            background: transparent !important;
            border-color: #404050;
            color: #888888;
        }

        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .header-section h1 {
                font-size: 1.5rem;
            }

            .header-section .btn-grupo {
                width: 100%;
                flex-direction: column;
            }

            .header-section .btn-grupo button,
            .header-section .btn-grupo a {
                width: 100%;
            }

            .table {
                font-size: 0.85rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-edit,
            .btn-delete {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" id="darkModeBtn">
        <i class="bi bi-moon"></i> Modo Oscuro
    </button>

    <div class="container-lg container-wrapper">
        <!-- Header -->
        <div class="header-section">
            <h1>
                <i class="bi bi-boxes"></i>
                Todos los Productos
            </h1>
            <div class="btn-grupo">
                <a href="/movimientos.html" class="back-button">
                    <i class="bi bi-arrow-up-right"></i> Movimientos
                </a>
                <a href="/dashboard.html" class="back-button">
                    <i class="bi bi-arrow-left"></i> Volver a Análisis
                </a>
                <button class="btn-new" id="btnNuevoProducto" data-bs-toggle="modal" data-bs-target="#modalProducto">
                    <i class="bi bi-plus-lg"></i> Nuevo Producto
                </button>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="row mb-4" id="estadisticas">
            <div class="col-md-3">
                <div class="stat-card">
                    <i class="bi bi-box"></i>
                    <h5>Total Productos</h5>
                    <p class="number" id="totalProductos">0</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h5>Stock Bajo</h5>
                    <p class="number" id="stockBajo">0</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <i class="bi bi-cash-coin"></i>
                    <h5>Valor Inventario</h5>
                    <p class="number" id="valorInventario">$0</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <i class="bi bi-percent"></i>
                    <h5>Margen Promedio</h5>
                    <p class="number" id="margenPromedio">0%</p>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"
                            style="background: transparent; border: 1.5px solid #e0e0e0; border-right: none;">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="filtroNombre"
                            placeholder="Buscar por nombre o código..." style="border-left: none;">
                    </div>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="filtroCategoria">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="VIGENTE">Vigente</option>
                        <option value="VENCIDO">Vencido</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tabla de Productos -->
        <div class="table-responsive" id="tablaContenedor">
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Producto -->
    <div class="modal fade" id="modalProducto" tabindex="-1" aria-labelledby="modalProductoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProductoLabel">Nuevo Producto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formProducto">
                        <input type="hidden" id="productoId">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="codigo" class="form-label">Código <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="codigo" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nombre" class="form-label">Nombre <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nombre" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" rows="2"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="categoria" class="form-label">Categoría <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="categoria" required>
                                        <option value="">Seleccione categoría</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ubicacion" class="form-label">Ubicación</label>
                                    <input type="text" class="form-control" id="ubicacion">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="precioCompra" class="form-label">Precio Compra <span
                                            class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="precioCompra" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="precioVenta" class="form-label">Precio Venta <span
                                            class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="precioVenta" step="0.01" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="cantidad" class="form-label">Cantidad <span
                                            class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="cantidad" value="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="stockMinimo" class="form-label">Stock Mínimo</label>
                                    <input type="number" class="form-control" id="stockMinimo" value="10">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="margenCalculado" class="form-label">Margen (%)</label>
                                    <input type="text" class="form-control" id="margenCalculado" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento</label>
                            <input type="date" class="form-control" id="fechaVencimiento">
                        </div>

                        <div class="alert alert-info d-none" id="margenInfo" role="alert">
                            <i class="bi bi-info-circle"></i> El margen se calcula automáticamente como (Precio Venta -
                            Precio Compra) / Precio Venta × 100
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarProducto">
                        <i class="bi bi-check-lg"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <script>
        let modalProducto;
        let productosFiltrados = [];
        let productosOriginal = [];

        // Dark mode
        const darkModeBtn = document.getElementById('darkModeBtn');

        // Cargar preferencia de dark mode
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            darkModeBtn.innerHTML = '<i class="bi bi-sun"></i> Modo Claro';
        }

        darkModeBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            darkModeBtn.innerHTML = isDark
                ? '<i class="bi bi-sun"></i> Modo Claro'
                : '<i class="bi bi-moon"></i> Modo Oscuro';
        });

        // Obtener token
        function getToken() {
            return localStorage.getItem('token');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function () {
            modalProducto = new bootstrap.Modal(document.getElementById('modalProducto'));
            cargarProductos();
            cargarCategorias();
            configurarEventos();
        });

        function configurarEventos() {
            // Calcular margen automáticamente
            document.getElementById('precioCompra').addEventListener('change', calcularMargen);
            document.getElementById('precioVenta').addEventListener('change', calcularMargen);

            // Guardar producto
            document.getElementById('btnGuardarProducto').addEventListener('click', guardarProducto);

            // Filtros
            document.getElementById('filtroNombre').addEventListener('keyup', aplicarFiltros);
            document.getElementById('filtroCategoria').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);

            // Nuevo producto
            document.getElementById('btnNuevoProducto').addEventListener('click', abrirNuevoProducto);
        }

        function calcularMargen() {
            const precioCompra = parseFloat(document.getElementById('precioCompra').value) || 0;
            const precioVenta = parseFloat(document.getElementById('precioVenta').value) || 0;

            if (precioCompra > 0 && precioVenta > 0) {
                const margen = ((precioVenta - precioCompra) / precioVenta * 100).toFixed(2);
                document.getElementById('margenCalculado').value = margen + '%';
                document.getElementById('margenInfo').classList.remove('d-none');
            } else {
                document.getElementById('margenCalculado').value = '';
                document.getElementById('margenInfo').classList.add('d-none');
            }
        }

        function cargarProductos() {
            const token = getToken();
            fetch('/api/productos', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar productos: ' + response.status);
                    }
                    return response.json();
                })
                .then(response => {
                    const datos = response.data || response;
                    productosOriginal = datos;
                    productosFiltrados = [...datos];
                    renderizarTabla(datos);
                    calcularEstadisticas(datos);
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', error.message, 'error');
                });
        }

        function renderizarTabla(productos) {
            if (productos.length === 0) {
                document.getElementById('tablaContenedor').innerHTML = `
                    <div class="alert alert-info text-center" role="alert">
                        <i class="bi bi-inbox"></i> No hay productos registrados
                    </div>
                `;
                return;
            }

            let html = `
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th>Precio Compra</th>
                            <th>Precio Venta</th>
                            <th>Stock</th>
                            <th>Stock Mín</th>
                            <th>Margen</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            productos.forEach(producto => {
                const margen = ((producto.precio_venta - producto.precio_compra) / producto.precio_venta * 100).toFixed(2);
                const margenClass = margen >= 50 ? 'margin-high' : (margen >= 25 ? 'margin-medium' : 'margin-low');
                const stockClass = producto.cantidad < producto.stock_minimo ? 'stock-bajo' : 'stock-normal';
                const estado = producto.fecha_vencimiento && new Date(producto.fecha_vencimiento) < new Date() ? 'VENCIDO' : 'VIGENTE';
                const estadoBadge = estado === 'VIGENTE' ? 'badge-vigente' : 'badge-vencido';

                html += `
                    <tr>
                        <td><strong>${producto.codigo}</strong></td>
                        <td>${producto.nombre}</td>
                        <td>${producto.categoria_nombre || '-'}</td>
                        <td>$${parseFloat(producto.precio_compra).toLocaleString('es-CO', { minimumFractionDigits: 0 })}</td>
                        <td>$${parseFloat(producto.precio_venta).toLocaleString('es-CO', { minimumFractionDigits: 0 })}</td>
                        <td class="${stockClass}">${producto.cantidad}</td>
                        <td>${producto.stock_minimo}</td>
                        <td><span class="margin-badge ${margenClass}">${margen}%</span></td>
                        <td><span class="badge-estado ${estadoBadge}">${estado}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit" onclick="editarProducto(${producto.id})" title="Editar">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <button class="btn-delete" onclick="eliminarProducto(${producto.id}, '${producto.nombre}', '${producto.codigo}')" title="Eliminar">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('tablaContenedor').innerHTML = html;
        }

        function calcularEstadisticas(productos) {
            const totalProductos = productos.length;
            const stockBajo = productos.filter(p => p.cantidad < p.stock_minimo).length;
            const valorInventario = productos.reduce((sum, p) => sum + (p.cantidad * p.precio_venta), 0);
            const margenPromedio = productos.length > 0
                ? (productos.reduce((sum, p) => sum + ((p.precio_venta - p.precio_compra) / p.precio_venta * 100), 0) / productos.length).toFixed(2)
                : 0;

            document.getElementById('totalProductos').textContent = totalProductos;
            document.getElementById('stockBajo').textContent = stockBajo;
            document.getElementById('valorInventario').textContent = '$' + valorInventario.toLocaleString('es-CO', { minimumFractionDigits: 0 });
            document.getElementById('margenPromedio').textContent = margenPromedio + '%';
        }

        function cargarCategorias() {
            const token = getToken();
            fetch('/api/categorias', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(response => {
                    const categorias = response.data || response;
                    const selectCategoria = document.getElementById('categoria');
                    const filtroCategoria = document.getElementById('filtroCategoria');

                    (Array.isArray(categorias) ? categorias : []).forEach(cat => {
                        const option = `<option value="${cat.id}">${cat.nombre}</option>`;
                        selectCategoria.innerHTML += option;
                        filtroCategoria.innerHTML += option;
                    });
                })
                .catch(error => console.error('Error al cargar categorías:', error));
        }

        function abrirNuevoProducto() {
            document.getElementById('productoId').value = '';
            document.getElementById('formProducto').reset();
            document.getElementById('modalProductoLabel').textContent = 'Nuevo Producto';
            document.getElementById('margenCalculado').value = '';
            document.getElementById('margenInfo').classList.add('d-none');
        }

        function editarProducto(id) {
            const token = getToken();
            // Fetch all products and filter by ID (backend doesn't have GET /productos/:id)
            fetch('/api/productos', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar productos');
                    }
                    return response.json();
                })
                .then(response => {
                    const productos = response.data || response;
                    const producto = productos.find(p => p.id === id);

                    if (!producto) {
                        throw new Error('Producto no encontrado');
                    }

                    document.getElementById('productoId').value = producto.id;
                    document.getElementById('codigo').value = producto.codigo;
                    document.getElementById('nombre').value = producto.nombre;
                    document.getElementById('descripcion').value = producto.descripcion || '';
                    document.getElementById('categoria').value = producto.id_categoria;
                    document.getElementById('ubicacion').value = producto.ubicacion || '';
                    document.getElementById('precioCompra').value = producto.precio_compra;
                    document.getElementById('precioVenta').value = producto.precio_venta;
                    document.getElementById('cantidad').value = producto.cantidad;
                    document.getElementById('stockMinimo').value = producto.stock_minimo;
                    document.getElementById('fechaVencimiento').value = producto.fecha_vencimiento ? producto.fecha_vencimiento.split('T')[0] : '';
                    document.getElementById('modalProductoLabel').textContent = 'Editar Producto';
                    calcularMargen();
                    modalProducto.show();
                })
                .catch(error => {
                    console.error('Error en editarProducto:', error);
                    Swal.fire('Error', 'No se pudo cargar el producto: ' + error.message, 'error');
                });
        }

        function guardarProducto() {
            const id = document.getElementById('productoId').value;
            const datos = {
                codigo: document.getElementById('codigo').value,
                nombre: document.getElementById('nombre').value,
                descripcion: document.getElementById('descripcion').value,
                id_categoria: document.getElementById('categoria').value,
                ubicacion: document.getElementById('ubicacion').value,
                precio_compra: parseFloat(document.getElementById('precioCompra').value),
                precio_venta: parseFloat(document.getElementById('precioVenta').value),
                cantidad: parseInt(document.getElementById('cantidad').value),
                stock_minimo: parseInt(document.getElementById('stockMinimo').value),
                fecha_vencimiento: document.getElementById('fechaVencimiento').value || null
            };

            const metodo = id ? 'PUT' : 'POST';
            const url = id ? `/api/productos/${id}` : '/api/productos';
            const token = getToken();

            fetch(url, {
                method: metodo,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(datos)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al guardar producto');
                    }
                    return response.json();
                })
                .then(() => {
                    Swal.fire('Éxito', id ? 'Producto actualizado' : 'Producto creado', 'success');
                    modalProducto.hide();
                    cargarProductos();
                })
                .catch(error => {
                    Swal.fire('Error', error.message, 'error');
                });
        }

        function eliminarProducto(id, nombre, codigo) {
            Swal.fire({
                title: '¿Eliminar producto?',
                text: `¿Está seguro que desea eliminar "${codigo} - ${nombre}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then(result => {
                if (result.isConfirmed) {
                    const token = getToken();
                    fetch(`/api/productos/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error al eliminar producto');
                            }
                            Swal.fire('Eliminado', 'Producto eliminado correctamente', 'success');
                            cargarProductos();
                        })
                        .catch(error => {
                            Swal.fire('Error', error.message, 'error');
                        });
                }
            });
        }

        function aplicarFiltros() {
            const filtroNombre = document.getElementById('filtroNombre').value.toLowerCase();
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            const filtroEstado = document.getElementById('filtroEstado').value;

            productosFiltrados = productosOriginal.filter(producto => {
                const coincideNombre = !filtroNombre ||
                    producto.nombre.toLowerCase().includes(filtroNombre) ||
                    producto.codigo.toLowerCase().includes(filtroNombre);

                const coincideCategoria = !filtroCategoria ||
                    producto.id_categoria == filtroCategoria;

                const estado = producto.fecha_vencimiento && new Date(producto.fecha_vencimiento) < new Date() ? 'VENCIDO' : 'VIGENTE';
                const coincideEstado = !filtroEstado || estado === filtroEstado;

                return coincideNombre && coincideCategoria && coincideEstado;
            });

            renderizarTabla(productosFiltrados);
            calcularEstadisticas(productosFiltrados);
        }
    </script>
</body>

</html>